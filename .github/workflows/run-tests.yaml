name: Run Agify tests

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  run-tests:
    runs-on: ubuntu-latest
    env:
      BASE_URL: ${{ vars.BASE_URL }}
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tool versions
        uses: jdx/mise-action@v2

      - name: Install Node dependencies
        run: pnpm install

      - name: Run Playwright BDD tests
        run: pnpm pw-start
        continue-on-error: true

      - name: Run Cucumber tests
        run: pnpm cu-start
        continue-on-error: true

      - name: Auth to GCloud
        if: always()
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.SERVICE_ACCOUNT }}

      - name: Upload Playwright Report
        id: upload-playwright-report
        if: always() && hashFiles('playwright-report/**/*') != ''
        uses: google-github-actions/upload-cloud-storage@v1
        with:
          path: playwright-report/
          destination: sqa-tech-task-test-reports/${{ github.run_id }}/playwright/
          process_gcloudignore: false
          parent: false
          predefinedAcl: publicRead

      - name: Upload Cucumber Report
        id: upload-cucumber-report
        if: always() && hashFiles('cucumber-report/**/*') != ''
        uses: google-github-actions/upload-cloud-storage@v1
        with:
          path: cucumber-report/
          destination: sqa-tech-task-test-reports/${{ github.run_id }}/cucumber/
          process_gcloudignore: false
          parent: false
          predefinedAcl: publicRead

      - name: Add Playwright report link to step summary
        if: steps.upload-playwright-report.outcome == 'success'
        run: |
          PLAYWRIGHT_URL="https://storage.googleapis.com/sqa-tech-task-test-reports/${{ github.run_id }}/playwright/index.html"
          echo "ðŸŽ­ [View Playwright Report](${PLAYWRIGHT_URL})" >> $GITHUB_STEP_SUMMARY

      - name: Add Cucumber report link to step summary
        if: steps.upload-cucumber-report.outcome == 'success'
        run: |
          CUCUMBER_URL="https://storage.googleapis.com/sqa-tech-task-test-reports/${{ github.run_id }}/cucumber/index.html"
          echo "ðŸ¥’ [View Cucumber Report](${CUCUMBER_URL})" >> $GITHUB_STEP_SUMMARY
